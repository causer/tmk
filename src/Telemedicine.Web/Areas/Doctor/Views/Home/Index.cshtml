@model IEnumerable<Telemedicine.Web.Areas.Doctor.Models.AppointmentViewModel>
@{
    ViewBag.Title = "Главная";
    Layout = "~/Views/Shared/_Layout3.cshtml";
}
<div class="row page-header container-fluid">
    <div class="pull-left currenttime">
        Время: <span id="currenttime"></span>
    </div>
    <div class="pull-right status-select">
        Текущий статус
        <span class="status active" style="margin-left: 15px">Занят</span>
        <span class="status-selector">
            <input type="checkbox" value="" onchange="$(this).parent().prev().toggleClass('active', !this.checked); $(this).parent().next().toggleClass('active', this.checked)" />
            <label onclick="$(this).prev().click()"></label>
        </span>
        <span class="status">Готов консультировать</span>
    </div>
</div>
<div style="display: flex;" class="doctormainpage" ng-controller="DoctorTimelineController as viewModel" data-id="@ViewBag.DoctorId">
    <div class="panel panel-default text-center" style="width: 292px;">
        <div id="calendar" class="panel-body"></div>
        <div id="currentdate" class="text-center"></div>
        <hr/>
        <div class="balance-info">
            <div class="text">Ваш баланс</div>
            <div class="summa">1486</div>
            <button class="btn btn-primary rounded">Подробнее</button>
        </div>
    </div>
    <div class="container-fluid" style="flex: 1">
        <div style="flex: 1; flex-wrap: wrap" class="timeline">
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">2:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">3:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">4:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">5:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">6:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">7:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">8:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">9:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">10:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">1:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">1:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">1:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">1:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">1:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">1:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">1:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">1:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">1:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">1:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">1:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">1:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">1:00</div>
            </div>
            <div class="hour">
                <div class="info plan panel-default panel"></div>
                <div class="time font-bold text-center">1:00</div>
            </div>
        </div>
        <div>
            <button type="button" class="btn btn-default rounded">Редактировать расписание</button>
        </div>
    </div>
</div>
<style>

</style>
<div class="row">
    <div class="col-md-4">
        @*        @Html.Action("GetStatus", "Status")*@
    </div>
</div>
<div style="height: calc(100% - 600px);min-height:200px">
    <div class="page-header currenttime" style="border:none;">
        Список пациентов на @DateTime.Now.ToShortDateString()
        <div class="pull-right">
            <button class="btn btn-white rounded">Ближайшие</button>
            <button class="btn btn-default rounded">В историю</button>
        </div>
    </div>
    <div class="grid" style="font-size: 12px;">
        <div class="page-header" style="border-top:1px solid #e4e4e4;border-bottom:1px solid #e4e4e4; padding-left: 0;">
            <table style="width: 100%">
                <tr class=" font-bold">
                    <td class="col-md-2 font-bold">
                        Время
                    </td>
                    <td class="col-md-3">Пациент</td>
                    <td class="col-md-3"></td>
                    <td class="col-md-2">Стоимость</td>
                    <td class="col-md-2"></td>
                </tr>
            </table>
        </div>
        <div class="grid-content">
            <table style="width: 100%; font-size: 14px;">
                <tr>
                    <td class="col-md-2">
                        <div class="timeicon">18:00</div>
                    </td>
                    <td class="col-md-3">Евгения Олеговна</td>
                    <td class="col-md-3">
                        <div class="partdocument orange">Карта пациента</div>
                    </td>
                    <td class="col-md-2">1000 <span class="font-rouble">i</span></td>
                    <td class="col-md-2"><a class="remove orange">Отменить</a></td>
                </tr>
                @foreach (var appointment in Model)
                {
                    <tr>
                        <td class="col-md-3">@appointment.Date.ToString("dd.MM.yyyy в HH:mm")</td>
                        <td class="col-md-9">@appointment.PatientFio</td>
                    </tr>
                }
            </table>
        </div>
    </div>
</div>
<div class="modal fade" id="CreateEvent" role="dialog" aria-labelledby="CreateEventLabel">
    <div class="modal-dialog  modal-sm" role="document">
        <div class="modal-content">

        </div>
    </div>
</div>

<div class="modal fade" id="addEventDialog">
    <div class="modal-dialog addTimeSpanEventDialog">
        <div class="modal-content">

        </div>
    </div>
</div>


<a style="display: none;" class="btn btn-primary rounded" data-toggle="modal" id="createEventLink" data-target="#CreateEvent" href="@Url.Action("AddCalendarEvent")">
</a>

@section scripts
{
    <script type="text/javascript">
        var EventStartDate;
        var EventDurationVal;
        var dates = [
            { "Class": "planned", "Date": "1995-06-23" },
            { "Class": "planned", "Date": "2014-05-01" },
            { "Class": "fault", "Date": "2015-06-17" },
            { "Class": "planned", "Date": "2015-08-03" }
        ];

        $('#calendar').datetimepicker({
            format: 'YYYY-MM-dd',
            inline: true,
            locale: 'ru',
            highlights: dates
        }).on('dp.change', function (e) {
            $('#currentdate').html(e.date.format('DD MMM, dd'));
        });
        $('#currentdate').html(moment().format('DD MMMM, dd'));
        $('.timeline').on('click', '.hour .info:not(.selected)', function () {
            $(this).toggleClass('selected', true);
            $(this).popover({
                container: '.main-container',
                title: 'Назначен прием',
                content: '<div class=actions><button>Назначить прием</button><button>Послать всех</button><button>123</button><button>123</button><button>123</button></div>',
                placement: 'bottom',
                html: true,
            });
            $(this).data('bs.popover').tip().addClass('timeline-item').attr('data-hourtype', $(this).closest('.info').attr('data-hourtype'));
            $(this).popover('show');
            $(this).on('hidden.bs.popover', function () {
                $(this).toggleClass('selected', false);
                $(this).popover('destroy');
            });

        });
        var timeline = $('.timeline');
        var str = '';
        var hours = [
            { type: 'working', humans: 0 },
            { type: 'working', humans: 2 },
            { type: 'working', humans: 3 },
            { type: 'working', humans: 4 },
            { type: 'working', humans: 1 },
            { type: 'working', humans: 0 },
            { type: 'working', humans: 0 },
            { type: '', humans: 0 },
            { type: '', humans: 0 },
            { type: '', humans: 0 },
            { type: '', humans: 0 },
            { type: '', humans: 0 },
            { type: '', humans: 0 },
            { type: '', humans: 0 },
            { type: '', humans: 0 },
            { type: '', humans: 0 },
            { type: '', humans: 0 },
            { type: '', humans: 0 },
            { type: '', humans: 0 },
            { type: 'notworking', humans: 0 },
            { type: 'notworking', humans: 0 },
            { type: 'notworking', humans: 0 },
            { type: 'notworking', humans: 0 },
            { type: 'notworking', humans: 0 },
        ];
        hours.forEach(function (hour, i) {
            var humans = '';
            for (var j = 0; j < hour.humans; j++) {
                humans += '<div class=human></div>';
            }
            str += '<div class="hour">\
                <div class="info ' + (hour.type || '') + ' panel-default panel" data-hourtype="' + hour.type + '">' + humans + '</div>\
                <div class="time font-bold text-center">' + (i + 1) + ':00</div>\
            </div>';
        });
        timeline.html(str);

        $('#currenttime').text(moment().format('HH:mm:ss'));
            setInterval(function () {
            $('#currenttime').text(moment().format('HH:mm:ss'));
            }, 100);

        $('body').on('click', function (e) {
            $('.hour .info').each(function () {
                //the 'is' for buttons that trigger popups
                //the 'has' for icons within a button that triggers a popup
                if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0) {
                    $(this).popover('destroy');
                }
            });
        });

        $(function () {
            $(".dropdown-menu li a").click(function () {
                $("#selectedMonth").text($(this).text());

            });

            var months = [
                "Январь", "Февраль", "Март", "Апрель", "Май", "Июнь",
                "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"
            ];

            $("#selectedMonth").text(months[(new Date()).getMonth()]);

            $("#selectedMonth").bind('DOMSubtreeModified', function () {
                if ($.inArray($("#selectedMonth").text(), months) == -1)
                    $("#selectedMonth").text(months[(new Date()).getMonth()]);
            });
            /* $('#EventStart').datetimepicker({
                locale:'ru'
            });*/
            $.getJSON('@Url.Action("GetEvents", "Events")', "json", function (data) {
                /* $('#calendar').fullCalendar({
                    firstDay: moment().format('d'),
                    header: false,
                    views: {
                        week: {
                            smallTimeFormat: 'H:mm',
                        }
                    },
                    timeFormat: 'H:mm',
                    columnFormat: '<i1>dd</i1><i2>DD</i2><i3>MMMM</i3>',
                    lang: 'ru',
                    events: data,
                    defaultView: "agendaWeek",
                    minTime: '07:00',
                    maxTime: '21:00',
                    height: 400,
                    allDaySlot: false,
                    axisWidth: '100px',
                    selectable: true,
                    selectHelper: true,
                    eventLimit: true,
                    slotDuration: '00:15:00',
                    select: function (start, end) {
                        $("#createEventLink").click();
                        //$('#CreateEvent').modal('toggle');
                        EventStartDate = start;
                        EventDurationVal = (end - start) / 60000;
                        //$('#EventStart').data('DateTimePicker').date(start);
                        //$('#EventDuration').val((end - start) / 60000);
                        //$('#EventDuration').change();
                        /*  var title = prompt('Наименование события:');
                        var eventData;
                        if (title) {
                            eventData = {
                                title: title,
                                start: start,
                                end: end
                            };
                            $('#calendar').fullCalendar('renderEvent', eventData, true); // stick? = true
                        }
                        $('#calendar').fullCalendar('unselect');#1#
                    },
                    //eventColor: '#3e67ae'
                });*/
            });

            //инициализация всплывающего окна дял добавления записи
            $("#beginDateDatetimePicker").datetimepicker({
                locale: 'ru'
            });
            $("#endDateDatetimePicker").datetimepicker({
                locale: 'ru'
            });
            $(".glyphicon-calendar").click(function () {
                $(this).parent().parent().find(".form-control").focus();
            });
            $('.dropdown-menu input, .dropdown-menu label').click(function (e) {
                e.stopPropagation();
            });

            $('#CreateEvent').on('shown.bs.modal', function () {
                var pickerTime = shiftTime(new Date(EventStartDate));

                $('#EventStart').datetimepicker({
                    locale: 'ru'
                });

                $('#EventStart').data('DateTimePicker').date(pickerTime);

                console.log(EventStartDate);
                console.log(EventDurationVal);
                $('#EventDuration').val(EventDurationVal);
                $('#EventDuration').change();
            });
        });


        function onAddSuccess() {
            $("#addEventDialog").modal('hide');
            window.location.href = '@Url.Action("Index", "Home")';
        }

        function onAddCalendarEventSuccess() {
            $("#CreateEvent").modal('hide');
            window.location.href = '@Url.Action("Index", "Home")';
        }

        function selectMonth(monthNumber) {
            var date = new Date();
            $('#calendar').fullCalendar('gotoDate', new Date(date.getFullYear(), monthNumber, 1));
        }

        function ArrowUp() {
            var d = $('#EventStart').data('DateTimePicker').date()._d;
            $('#EventStart').data('DateTimePicker').date(new Date(d.setDate(d.getDate() + 1)));
        };

        function ArrowDown() {
            var d = $('#EventStart').data('DateTimePicker').date()._d;
            $('#EventStart').data('DateTimePicker').date(new Date(d.setDate(d.getDate() - 1)));
        };

        function ArrowLeft() {
            var d = $('#EventStart').data('DateTimePicker').date()._d;
            $('#EventStart').data('DateTimePicker').date(new Date(d.setMinutes(d.getMinutes() - 15)));
        };

        function ArrowRight() {
            var d = $('#EventStart').data('DateTimePicker').date()._d;
            $('#EventStart').data('DateTimePicker').date(new Date(d.setMinutes(d.getMinutes() + 15)));
        };

        function shiftTime(date) {
            var minutes = date.getMinutes();
            var shift = minutes % 15;
            if (shift > 0) {
                var timeshift = 15 - shift;
                date.setMinutes(minutes + timeshift);
            }
            var utc = date.getTime() + (date.getTimezoneOffset() * 60000);
            return new Date(utc);
        }

    </script>
}