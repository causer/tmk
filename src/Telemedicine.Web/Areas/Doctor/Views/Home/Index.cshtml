@model IEnumerable<Telemedicine.Web.Areas.Doctor.Models.AppointmentViewModel>
@{
    ViewBag.Title = "Главная";
    Layout = "~/Views/Shared/_Layout3.cshtml";
}
<br />
<div class="row">
    <div class="col-md-4">
        @Html.Action("GetStatus", "Status")
    </div>
</div>
<br />

<div id="calendar"></div>

<div style="height:calc(100% - 600px)">
    <h3 class="page-header font-bold" style="border:none;">Записи на сегодня</h3>
    <div class="grid">
        <div class="page-header" style="border-top:1px solid #e4e4e4;border-bottom:1px solid #e4e4e4; padding-left: 0;">
            <table style="width: 100%">
                <tr>
                    <td class="col-md-3 uppercase font-bold">Время</td>
                    <td class="col-md-9 uppercase font-bold">Пациент</td>
                </tr>
            </table>
        </div>
        <div class="grid-content">
            <table style="width: 100%; ">
                @foreach (var appointment in Model)
                {
                    <tr>
                        <td class="col-md-3">@appointment.Date.ToString("dd.MM.yyyy в HH:mm")</td>
                        <td class="col-md-9">@appointment.PatientFio</td>
                    </tr>
                }
            </table>
        </div>
    </div>
</div>
<div class="modal fade" id="CreateEvent" role="dialog" aria-labelledby="CreateEventLabel">
    <div class="modal-dialog  modal-sm" role="document">
        <div class="modal-content">
                    
                </div>
            </div>
            </div>

<div class="modal fade" id="addEventDialog">
    <div class="modal-dialog addTimeSpanEventDialog">
        <div class="modal-content">

        </div>
    </div>
</div>


<a style="display: none;" class="btn btn-primary rounded" data-toggle="modal" id="createEventLink" data-target="#CreateEvent" href="@Url.Action("AddCalendarEvent")">
</a>

@section scripts
{
    <script type="text/javascript">
        var EventStartDate;
        var EventDurationVal;

        $(function () {
            $(".dropdown-menu li a").click(function () {
                $("#selectedMonth").text($(this).text());

            });

            var months = [
                "Январь", "Февраль", "Март", "Апрель", "Май", "Июнь",
                "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"
            ];

            $("#selectedMonth").text(months[(new Date()).getMonth()]);

            $("#selectedMonth").bind('DOMSubtreeModified', function () {
                if ($.inArray($("#selectedMonth").text(), months) == -1)
                    $("#selectedMonth").text(months[(new Date()).getMonth()]);
            });
           /* $('#EventStart').datetimepicker({
                locale:'ru'
            });*/
            $.getJSON('@Url.Action("GetEvents", "Events")', "json", function (data) {
                $('#calendar').fullCalendar({
                    firstDay: moment().format('d'),
                    header: false,
                    views: {
                        week: {
                            smallTimeFormat: 'H:mm',
                        }
                    },
                    timeFormat: 'H:mm',
                    columnFormat: '<i1>dd</i1><i2>DD</i2><i3>MMMM</i3>',
                    lang: 'ru',
                    events: data,
                    defaultView: "agendaWeek",
                    minTime: '07:00',
                    maxTime: '21:00',
                    height: 400,
                    allDaySlot: false,
                    axisWidth: '100px',
                    selectable: true,
                    selectHelper: true,
                    eventLimit: true,
                    slotDuration: '00:15:00',
                    select: function (start, end) {
                        $("#createEventLink").click();
                        //$('#CreateEvent').modal('toggle');
                        EventStartDate = start;
                        EventDurationVal = (end - start) / 60000;
                        //$('#EventStart').data('DateTimePicker').date(start);
                        //$('#EventDuration').val((end - start) / 60000);
                        //$('#EventDuration').change();
                        /*  var title = prompt('Наименование события:');
                        var eventData;
                        if (title) {
                            eventData = {
                                title: title,
                                start: start,
                                end: end
                            };
                            $('#calendar').fullCalendar('renderEvent', eventData, true); // stick? = true
                        }
                        $('#calendar').fullCalendar('unselect');*/
                    },
                    //eventColor: '#3e67ae'
                });
            });

            //инициализация всплывающего окна дял добавления записи
            $("#beginDateDatetimePicker").datetimepicker({
                locale: 'ru'
            });
            $("#endDateDatetimePicker").datetimepicker({
                locale: 'ru'
            });
            $(".glyphicon-calendar").click(function () {
                $(this).parent().parent().find(".form-control").focus();
            });
            $('.dropdown-menu input, .dropdown-menu label').click(function (e) {
                e.stopPropagation();
            });

            $('#CreateEvent').on('shown.bs.modal', function () {
                var pickerTime = shiftTime(new Date(EventStartDate));

                $('#EventStart').datetimepicker({
                    locale: 'ru'
                });

                $('#EventStart').data('DateTimePicker').date(pickerTime);

                console.log(EventStartDate);
                console.log(EventDurationVal);
                $('#EventDuration').val(EventDurationVal);
                $('#EventDuration').change();
            });
        });


        function onAddSuccess() {
            $("#addEventDialog").modal('hide');
            window.location.href = '@Url.Action("Index", "Home")';
        }

        function onAddCalendarEventSuccess() {
            $("#CreateEvent").modal('hide');
            window.location.href = '@Url.Action("Index", "Home")';
        }

        function selectMonth(monthNumber) {
            var date = new Date();
            $('#calendar').fullCalendar('gotoDate', new Date(date.getFullYear(), monthNumber, 1));
        }

        function ArrowUp() {
            var d = $('#EventStart').data('DateTimePicker').date()._d;
            $('#EventStart').data('DateTimePicker').date(new Date(d.setDate(d.getDate() + 1)));
        };

        function ArrowDown() {
            var d = $('#EventStart').data('DateTimePicker').date()._d;
            $('#EventStart').data('DateTimePicker').date(new Date(d.setDate(d.getDate() - 1)));
        };

        function ArrowLeft() {
            var d = $('#EventStart').data('DateTimePicker').date()._d;
            $('#EventStart').data('DateTimePicker').date(new Date(d.setMinutes(d.getMinutes() - 15)));
        };
        function ArrowRight() {
            var d = $('#EventStart').data('DateTimePicker').date()._d;
            $('#EventStart').data('DateTimePicker').date(new Date(d.setMinutes(d.getMinutes() + 15)));
        };

        function shiftTime(date) {
            var minutes = date.getMinutes();
            var shift = minutes % 15;
            if (shift > 0) {
                var timeshift = 15 - shift;
                date.setMinutes(minutes + timeshift);
            }
            var utc = date.getTime() + (date.getTimezoneOffset() * 60000);
            return new Date(utc);
        }

    </script>
}