@model IEnumerable<Telemedicine.Web.Areas.Doctor.Models.AppointmentViewModel>
@{
    ViewBag.Title = "Главная";
    Layout = "~/Views/Shared/_Layout3.cshtml";
}
<br />
<div class="row">
    <div class="col-md-4">
        @Html.Action("GetStatus", "Status")
    </div>
</div>
<br />
<div class="pull-right" style="font-size: 10px;">
    <a class="btn btn-default rounded" onclick="$('#calendar').fullCalendar('today')">
        Сегодня
    </a>
    <span class="input-group rounded" style="display: inline-block;">
        <a class="btn btn-default " onclick="$('#calendar').fullCalendar('prev')">
            <span class="tm icon arrow-left white"></span>

        </a>
        <a class="btn btn-default " onclick="$('#calendar').fullCalendar('next')">
            <span class="tm icon arrow-right white"></span>
        </a>
    </span>
    <div class="dropdown rounded" style="display: inline-block; width: 120px;">
        <a class="btn btn-primary dropdown-toggle" id="selectMonth" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
            <span id="selectedMonth" class="uppercase" style="font-size:11px">Месяц</span> <span class="caret"></span>
        </a>
        <ul class="dropdown-menu" role="menu" aria-labelledby="selectMonth">
            <li>
                <a onclick=" selectMonth(0); ">Январь</a>
            </li>
            <li>
                <a onclick=" selectMonth(1); ">Февраль</a>
            </li>
            <li>
                <a onclick=" selectMonth(2); ">Март</a>
            </li>
            <li>
                <a onclick=" selectMonth(3); ">Апрель</a>
            </li>
            <li>
                <a onclick=" selectMonth(4); ">Май</a>
            </li>
            <li>
                <a onclick=" selectMonth(5); ">Июнь</a>
            </li>
            <li>
                <a onclick=" selectMonth(6); ">Июль</a>
            </li>
            <li>
                <a onclick=" selectMonth(7); ">Август</a>
            </li>
            <li>
                <a onclick=" selectMonth(8); ">Сентябрь</a>
            </li>
            <li>
                <a onclick=" selectMonth(9); ">Отктябрь</a>
            </li>
            <li>
                <a onclick=" selectMonth(10); ">Ноябрь</a>
            </li>
            <li>
                <a onclick=" selectMonth(11); ">Декабрь</a>
            </li>
        </ul>
    </div>

    <a class="btn btn-primary rounded" data-toggle="modal" data-target="#addEventDialog" href="@Url.Action("AddTimeSpanEvent")" title="Добавить событие">
        <span class="glyphicon">+</span> Добавить
    </a>
</div>

<div id="calendar"></div>

<div style="height:calc(100% - 600px)">
    <h3 class="page-header font-bold" style="border:none;">Записи на сегодня</h3>
    <div class="grid">
        <div class="page-header" style="border-top:1px solid #e4e4e4;border-bottom:1px solid #e4e4e4; padding-left: 0;">
            <table style="width: 100%">
                <tr>
                    <td class="col-md-3 uppercase font-bold">Время</td>
                    <td class="col-md-9 uppercase font-bold">Пациент</td>
                </tr>
            </table>
        </div>
        <div class="grid-content">
            <table style="width: 100%; ">
                @foreach (var appointment in Model)
                {
                    <tr>
                        <td class="col-md-3">@appointment.Date.ToString("dd.MM.yyyy в HH:mm")</td>
                        <td class="col-md-9">@appointment.PatientFio</td>
                    </tr>
                }
            </table>
        </div>
    </div>
</div>
<div class="modal fade" id="CreateEvent" role="dialog" aria-labelledby="CreateEventLabel">
    <div class="modal-dialog  modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="CreateEventLabel">Добавить прием</h4>
            </div>
            <div class="modal-body">
                <div>
                    Начальная дата
                    <div class="text-center">
                        <button style="background: transparent; border: none; outline: none;" onclick="var d = $('#EventStart').data('DateTimePicker').date()._d; $('#EventStart').data('DateTimePicker').date(new Date(d.setMinutes(d.getMinutes() + 15)));">
                            <div class="tm icon arrow-up"></div>
                        </button>
                    </div>
                    <div style="display: flex;">
                        <button style="background: transparent; border: none; outline: none;" onclick="var d = $('#EventStart').data('DateTimePicker').date()._d; $('#EventStart').data('DateTimePicker').date(new Date(d.setDate(d.getDate() - 1)));">
                            <div class="tm icon arrow-left"></div>
                        </button>
                        <input class="datepicker text-center" id="EventStart" style="flex: 1; font-weight: 700; border: none;outline: none"/>
                        <button style="background: transparent; border: none; outline: none;" onclick="var d = $('#EventStart').data('DateTimePicker').date()._d; $('#EventStart').data('DateTimePicker').date(new Date(d.setDate(d.getDate() + 1)));">
                            <div class="tm icon arrow-right"></div>
                        </button>
                    </div>

                    <div class="text-center">
                        <button style="background: transparent; border: none; outline: none;" onclick="var d = $('#EventStart').data('DateTimePicker').date()._d; $('#EventStart').data('DateTimePicker').date(new Date(d.setMinutes(d.getMinutes() - 15)));">
                            <div class="tm icon arrow-down"></div>
                        </button>
                    </div>
                </div>
                <div>
                    Длительность
                    <br/>
                    <br/>
                    <div class="text-center" style="display: flex;">
                        <button style="background: transparent; border: none; outline: none;" onclick="EventDuration.value = parseInt(EventDuration.value) - 15;$(EventDuration).change()">
                            <div class="tm icon arrow-left"></div>
                        </button>
                        <label id="EventDurationText" style="flex: 1" onclick="$(this).toggle(false); $(EventDuration).toggle(true).focus();"></label>
                        <input id="EventDuration" class="text-center" onchange="var t = parseInt(EventDuration.value) || 0; if (t < 0) { t = 0 }; this.value = t; EventDurationText.innerHTML = (t > 59 ? Math.floor(t / 60) + ' ч. ' : '') + (t % 60) + ' мин.'; $(EventDurationText).toggle(true); $(EventDuration).toggle(false).focus()" style="display: none; flex: 1; font-weight: 700; outline: none; border: none;" onblur="$(this).change()" />
                        <button style="background: transparent; border: none; outline: none;" onclick="EventDuration.value = parseInt(EventDuration.value) + 15; $(EventDuration).change()">
                            <div class="tm icon arrow-right"></div>
                        </button>
                    </div>
                    
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary rounded">Добавить</button>
                <button type="button" class="btn btn-default rounded" data-dismiss="modal">Отменить</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addEventDialog">
    <div class="modal-dialog addTimeSpanEventDialog">
        <div class="modal-content">

        </div>
    </div>
</div>

@section scripts
{
    <script type="text/javascript">
        $(function () {
            $(".dropdown-menu li a").click(function () {
                $("#selectedMonth").text($(this).text());

            });

            var months = [
                "Январь", "Февраль", "Март", "Апрель", "Май", "Июнь",
                "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"
            ];

            $("#selectedMonth").text(months[(new Date()).getMonth()]);

            $("#selectedMonth").bind('DOMSubtreeModified', function () {
                if ($.inArray($("#selectedMonth").text(), months) == -1)
                    $("#selectedMonth").text(months[(new Date()).getMonth()]);
            });
            $('#EventStart').datetimepicker({
                locale:'ru'
            });
            $.getJSON('@Url.Action("GetEvents", "Events")', "json", function (data) {
                $('#calendar').fullCalendar({
                    header: {
                        left: 'title',
                        center: '',
                        right: ''
                    },
                    views: {
                        week: {
                            smallTimeFormat: 'H:mm',
                        }
                    },
                    timeFormat: 'H:mm',
                    columnFormat: '<i1>dd</i1><i2>DD</i2><i3>MMMM</i3>',
                    lang: 'ru',
                    events: data,
                    defaultView: "agendaWeek",
                    minTime: '07:00',
                    maxTime: '21:00',
                    height: 400,
                    allDaySlot: false,
                    axisWidth: '100px',
                    selectable: true,
                    selectHelper: true,
                    eventLimit: true,
                    slotDuration: '00:15:00',
                    select: function (start, end) {
                        $('#CreateEvent').modal('toggle');
                        $('#EventStart').data('DateTimePicker').date(start);
                        $('#EventDuration').val((end - start) / 60000);
                        $('#EventDuration').change();
                        /*  var title = prompt('Наименование события:');
                        var eventData;
                        if (title) {
                            eventData = {
                                title: title,
                                start: start,
                                end: end
                            };
                            $('#calendar').fullCalendar('renderEvent', eventData, true); // stick? = true
                        }
                        $('#calendar').fullCalendar('unselect');*/
                    },
                    //eventColor: '#3e67ae'
                });
            });

            //инициализация всплывающего окна дял добавления записи
            $("#beginDateDatetimePicker").datetimepicker({
                locale: 'ru'
            });
            $("#endDateDatetimePicker").datetimepicker({
                locale: 'ru'
            });
            $(".glyphicon-calendar").click(function () {
                $(this).parent().parent().find(".form-control").focus();
            });
            $('.dropdown-menu input, .dropdown-menu label').click(function (e) {
                e.stopPropagation();
            });
        });


        function onAddSuccess() {
            $("#addEventDialog").modal('hide');
            window.location.href = '@Url.Action("Index", "Home")';
        }

        function selectMonth(monthNumber) {
            var date = new Date();
            $('#calendar').fullCalendar('gotoDate', new Date(date.getFullYear(), monthNumber, 1));
        }

    </script>
}